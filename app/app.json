[{"name":"app.R","content":"source(\"app5.R\", local = TRUE)\n","type":"text"},{"name":"app5.R","content":"# ==============================================================================\n# DASHBOARD SHINY — FILTROS (AND) COM LISTAS SINCRONIZADAS (CASCATA)\n# Correção: ao filtrar por Macrocategoria (ou qualquer filtro), os elementos derivados\n# (Filmes, Caregoria/Categorias, Macrocategorias, etc.) passam a obedecer estritamente\n# ao recorte AND, e as listas dos filtros são atualizadas para refletir a interseção.\n# ==============================================================================\n# OBS: UI permanece igual (apenas comportamento server-side das choices/selected).\n# ==============================================================================\n\nsuppressPackageStartupMessages({\n  library(shiny)\n  library(plotly)\n  library(dplyr)\n  library(DT)\n  library(stringr)\n  library(scales)\n  library(htmlwidgets)\n})\n\n`%||%` <- function(a, b) if (!is.null(a)) a else b\n\n# ------------------------------------------------------------------------------\n# 1) DADOS\n# ------------------------------------------------------------------------------\nstopifnot(exists(\"x3_NOVO_DadosIntegradosAgentesTodosDetalhado\"))\ndados_raw <- x3_NOVO_DadosIntegradosAgentesTodosDetalhado %>% as.data.frame()\n\nreq_cols <- c(\"Agente\", \"Agente Padronizado\", \"Tema Nível\", \"Nome Filme\")\nmiss <- setdiff(req_cols, names(dados_raw))\nif (length(miss) > 0) stop(\"Colunas ausentes no dataset: \", paste(miss, collapse = \", \"))\n\nsnip256 <- function(x) {\n  s <- as.character(x)\n  s[is.na(s)] <- \"\"\n  s <- str_squish(s)\n  str_trunc(s, width = 256, side = \"right\", ellipsis = \"…\")\n}\nsafe_chr <- function(x) {\n  s <- as.character(x)\n  s[is.na(s)] <- \"\"\n  s\n}\n\ncol_2009 <- \"2009_Como você resumiria este filme? (em poucas palavras)\"\ncol_2013 <- \"2013a_Em uma ou duas palavras é um filme sobre...:\"\ncol_caregoria <- \"Caregoria\"\ncol_dna <- \"DNA-Mnem\"\ncol_score_tema <- \"Score Nível Tema\"\n\n# ------------------------------------------------------------------------------\n# 2) PALETA / FORMAS\n# ------------------------------------------------------------------------------\nPALETA_CORES <- c(\n  \"Autor\" = \"#D32F2F\",\n  \"Autor_N1\" = \"#EF9A9A\",\n  \"Autor_N3\" = \"#E53935\",\n  \"Autor_N5\" = \"#B71C1C\",\n  \"Par\" = \"#FDD835\",\n  \"Analista\" = \"#26C6DA\",\n  \"Analista_SV\" = \"#1FA7C5\",\n  \"Analista_VS\" = \"#0097A7\",\n  \"IA\" = \"#135CAD\",\n  \"ChatGPT\" = \"#4C9FEA\",\n  \"Gemini\" = \"#1E88E5\",\n  \"Outro\" = \"#9E9E9E\"\n)\n\nPLOTLY_SYMBOLS <- c(\n  \"Autor\" = \"square\",\n  \"Autor_N1\" = \"square\",\n  \"Autor_N3\" = \"square\",\n  \"Autor_N5\" = \"square\",\n  \"Par\" = \"square-open\",\n  \"Analista\" = \"diamond\",\n  \"Analista_SV\" = \"triangle-up\",\n  \"Analista_VS\" = \"triangle-down\",\n  \"IA\" = \"x\",\n  \"ChatGPT\" = \"asterisk\",\n  \"Gemini\" = \"hash\",\n  \"Outro\" = \"circle\"\n)\n\nFILME_COR <- \"#39D353\"\nFILME_SYMBOL <- \"star\"\nFILME_SIZE <- 22\n\nMACRO_COR <- \"#7A7A7A\"\nMACRO_SYMBOL <- \"circle-open\"\nMACRO_SIZE <- 26\n\nCAT_COR <- \"#4A4A4A\"\nCAT_SYMBOL <- \"circle\"\nCAT_SIZE <- round(MACRO_SIZE * 0.8)\n\nLINHA_COR_FILME_AGENTE <- \"#606060\"\nLINHA_COR_CAT_MACRO <- \"#9A9A9A\"\nLINHA_LARGURA <- 1\n\n# ------------------------------------------------------------------------------\n# 3) CATEGORIZAÇÃO + NORMALIZAÇÕES\n# ------------------------------------------------------------------------------\ncategorizar_agente <- function(agente, agente_pad, analista) {\n  txt <- paste(agente %||% \"\", agente_pad %||% \"\", analista %||% \"\", sep = \" | \")\n  txt <- tolower(txt)\n  \n  if (grepl(\"autor\", txt)) {\n    if (grepl(\"\\\\bn1\\\\b\", txt)) return(\"Autor_N1\")\n    if (grepl(\"\\\\bn3\\\\b\", txt)) return(\"Autor_N3\")\n    if (grepl(\"\\\\bn5\\\\b\", txt)) return(\"Autor_N5\")\n    return(\"Autor\")\n  }\n  if (grepl(\"par\", txt)) return(\"Par\")\n  if (grepl(\"analista\", txt)) {\n    if (grepl(\"\\\\bsv\\\\b\", txt)) return(\"Analista_SV\")\n    if (grepl(\"\\\\bvs\\\\b\", txt)) return(\"Analista_VS\")\n    return(\"Analista\")\n  }\n  if (grepl(\"chatgpt\", txt)) return(\"ChatGPT\")\n  if (grepl(\"gemini\", txt)) return(\"Gemini\")\n  if (grepl(\"\\\\bia\\\\b|intelig\", txt)) return(\"IA\")\n  \"Outro\"\n}\n\ndados <- dados_raw %>%\n  mutate(\n    AgentePad = as.character(`Agente Padronizado`),\n    TemaNivel = as.character(`Tema Nível`),\n    FilmeNome = as.character(`Nome Filme`),\n    AnalistaTxt = if (\"Analista\" %in% names(.)) as.character(.data[[\"Analista\"]]) else NA_character_,\n    # Importante: padroniza espaços para evitar “parece não filtrar” por mismatch de strings\n    MacrocategoriaTxt = if (\"Macrocategoria\" %in% names(.)) str_squish(as.character(.data[[\"Macrocategoria\"]])) else NA_character_,\n    CaregoriaTxt = if (col_caregoria %in% names(.)) str_squish(as.character(.data[[col_caregoria]])) else NA_character_,\n    DNAMnemTxt = if (col_dna %in% names(.)) str_squish(as.character(.data[[col_dna]])) else NA_character_,\n    ScoreNivelTemaTxt = if (col_score_tema %in% names(.)) suppressWarnings(as.numeric(.data[[col_score_tema]])) else NA_real_,\n    Categoria_Agente = mapply(categorizar_agente, .data[[\"Agente\"]], AgentePad, AnalistaTxt),\n    Categoria_Agente = factor(Categoria_Agente, levels = names(PALETA_CORES))\n  ) %>%\n  group_by(AgentePad) %>%\n  mutate(FreqAgente_Global = n()) %>%\n  ungroup() %>%\n  mutate(\n    MedidaPonderada_FreqAgente_x_ScoreTema = ifelse(\n      is.na(ScoreNivelTemaTxt), NA_real_,\n      FreqAgente_Global * ScoreNivelTemaTxt\n    )\n  )\n\ncolunas_numericas <- names(dados)[vapply(dados, is.numeric, logical(1))]\nif (length(colunas_numericas) < 2) stop(\"Precisa de pelo menos 2 colunas numéricas para X e Y.\")\n\npick_default <- function(cands, fallback) {\n  hit <- intersect(cands, colunas_numericas)\n  if (length(hit) > 0) hit[1] else fallback\n}\ndefault_x <- pick_default(\n  c(\"Score de Participação autores ou pares de -2 a 5\", \"Score Nível Tema\", \"ScoreNivelTemaTxt\"),\n  colunas_numericas[1]\n)\ndefault_y <- pick_default(\n  c(\"ValorConcordMesoCatLog10/2\", \"ValorConcordMesoCat\"),\n  colunas_numericas[min(2, length(colunas_numericas))]\n)\n\n# ------------------------------------------------------------------------------\n# 4) OUTPUTS versionado\n# ------------------------------------------------------------------------------\noutputs_dir <- file.path(getwd(), \"outputs\")\nif (!dir.exists(outputs_dir)) dir.create(outputs_dir, recursive = TRUE)\n\nnext_version_path <- function(prefix = \"dispersao_agentes\", ext = \".html\") {\n  files <- list.files(outputs_dir, pattern = paste0(\"^\", prefix, \"_v\\\\d{3}\\\\\", ext, \"$\"), full.names = FALSE)\n  v <- 0L\n  if (length(files) > 0) {\n    nums <- suppressWarnings(as.integer(str_extract(files, \"(?<=_v)\\\\d{3}\")))\n    nums <- nums[!is.na(nums)]\n    if (length(nums) > 0) v <- max(nums)\n  }\n  file.path(outputs_dir, sprintf(\"%s_v%03d%s\", prefix, v + 1L, ext))\n}\n\n# ------------------------------------------------------------------------------\n# 5) MEDIDAS CALCULADAS (no recorte filtrado)\n# ------------------------------------------------------------------------------\nadd_calculated_measures <- function(d) {\n  d <- d %>%\n    group_by(AgentePad) %>%\n    mutate(FreqAgente_Filtrado = n()) %>%\n    ungroup() %>%\n    mutate(\n      MedidaPonderada_FreqAgente_x_ScoreTema = ifelse(\n        is.na(ScoreNivelTemaTxt), NA_real_,\n        FreqAgente_Filtrado * ScoreNivelTemaTxt\n      )\n    )\n  d\n}\n\n# ------------------------------------------------------------------------------\n# 6) PREP PLOT DATA (agentes)\n# ------------------------------------------------------------------------------\nprep_plot_data <- function(d, xcol, ycol, agregar = TRUE, tipo = \"ftc\") {\n  d <- d %>% filter(!is.na(.data[[xcol]]), !is.na(.data[[ycol]]))\n  if (!agregar) return(d)\n  \n  g <- switch(\n    tipo,\n    \"ftc\" = d %>% group_by(FilmeNome, TemaNivel, Categoria_Agente),\n    \"fc\"  = d %>% group_by(FilmeNome, Categoria_Agente),\n    \"tc\"  = d %>% group_by(TemaNivel, Categoria_Agente),\n    d %>% group_by(FilmeNome, TemaNivel, Categoria_Agente)\n  )\n  \n  d2 <- g %>%\n    summarise(\n      n = n(),\n      AgentePad = dplyr::first(AgentePad),\n      Macrocategoria = dplyr::first(MacrocategoriaTxt),\n      Caregoria = dplyr::first(CaregoriaTxt),\n      `DNA-Mnem` = dplyr::first(DNAMnemTxt),\n      ScoreNivelTema = dplyr::first(ScoreNivelTemaTxt),\n      FreqAgente_Filtrado = dplyr::first(FreqAgente_Filtrado),\n      MedidaPonderada_FreqAgente_x_ScoreTema = dplyr::first(MedidaPonderada_FreqAgente_x_ScoreTema),\n      `2009_Como você resumiria este filme? (em poucas palavras)` =\n        if (col_2009 %in% names(d)) dplyr::first(.data[[col_2009]]) else NA_character_,\n      `2013a_Em uma ou duas palavras é um filme sobre...:` =\n        if (col_2013 %in% names(d)) dplyr::first(.data[[col_2013]]) else NA_character_,\n      x = mean(.data[[xcol]], na.rm = TRUE),\n      y = mean(.data[[ycol]], na.rm = TRUE),\n      .groups = \"drop\"\n    )\n  \n  d2[[xcol]] <- d2$x\n  d2[[ycol]] <- d2$y\n  d2\n}\n\n# ------------------------------------------------------------------------------\n# 7) PLOTLY — dispersão (filmes, macro, categoria, linhas)\n# ------------------------------------------------------------------------------\nmake_plotly_scatter <- function(d_points, d_base, xcol, ycol, var_tamanho = \"none\",\n                                transparencia = 0.7, mostrar_legenda = TRUE) {\n  \n  d_base_xy <- d_base %>% filter(!is.na(.data[[xcol]]), !is.na(.data[[ycol]]))\n  if (nrow(d_points) == 0) {\n    return(plot_ly() %>% layout(title = list(text = \"Sem dados após filtros\", x = 0.5)))\n  }\n  \n  # Filmes\n  filmes_cent <- d_base_xy %>%\n    group_by(FilmeNome) %>%\n    summarise(\n      x_filme = mean(.data[[xcol]], na.rm = TRUE),\n      y_filme = mean(.data[[ycol]], na.rm = TRUE),\n      n_filme = n(),\n      Macrocategoria = dplyr::first(MacrocategoriaTxt),\n      Caregoria = dplyr::first(CaregoriaTxt),\n      `DNA-Mnem` = dplyr::first(DNAMnemTxt),\n      MedidaPonderada_FreqAgente_x_ScoreTema = mean(MedidaPonderada_FreqAgente_x_ScoreTema, na.rm = TRUE),\n      .groups = \"drop\"\n    )\n  \n  filmes_cent$hover_filme <- paste0(\n    \"<b>Filme:<\/b> \", safe_chr(filmes_cent$FilmeNome),\n    \"<br><b>n:<\/b> \", filmes_cent$n_filme,\n    ifelse(is.na(filmes_cent$Macrocategoria) | filmes_cent$Macrocategoria == \"\", \"\", paste0(\"<br><b>Macrocategoria:<\/b> \", safe_chr(filmes_cent$Macrocategoria))),\n    ifelse(is.na(filmes_cent$Caregoria) | filmes_cent$Caregoria == \"\", \"\", paste0(\"<br><b>Caregoria:<\/b> \", safe_chr(filmes_cent$Caregoria))),\n    ifelse(is.na(filmes_cent$`DNA-Mnem`) | filmes_cent$`DNA-Mnem` == \"\", \"\", paste0(\"<br><b>DNA-Mnem:<\/b> \", safe_chr(filmes_cent$`DNA-Mnem`))),\n    \"<hr>\",\n    \"<b>Centróide X:<\/b> \", format(filmes_cent$x_filme, digits = 6),\n    \"<br><b>Centróide Y:<\/b> \", format(filmes_cent$y_filme, digits = 6)\n  )\n  \n  # Macrocategorias\n  macro_cent <- d_base_xy %>%\n    filter(!is.na(MacrocategoriaTxt), MacrocategoriaTxt != \"\") %>%\n    group_by(MacrocategoriaTxt) %>%\n    summarise(\n      x_macro = mean(.data[[xcol]], na.rm = TRUE),\n      y_macro = mean(.data[[ycol]], na.rm = TRUE),\n      n_macro = n(),\n      n_filmes = n_distinct(FilmeNome),\n      .groups = \"drop\"\n    ) %>% rename(Macrocategoria = MacrocategoriaTxt)\n  \n  macro_cent$hover_macro <- paste0(\n    \"<b>Macrocategoria:<\/b> \", safe_chr(macro_cent$Macrocategoria),\n    \"<br><b>n:<\/b> \", macro_cent$n_macro,\n    \"<br><b>n filmes:<\/b> \", macro_cent$n_filmes,\n    \"<hr>\",\n    \"<b>Centróide X:<\/b> \", format(macro_cent$x_macro, digits = 6),\n    \"<br><b>Centróide Y:<\/b> \", format(macro_cent$y_macro, digits = 6)\n  )\n  \n  # Categorias (Caregoria) vinculadas a macro\n  cat_cent <- d_base_xy %>%\n    filter(!is.na(CaregoriaTxt), CaregoriaTxt != \"\", !is.na(MacrocategoriaTxt), MacrocategoriaTxt != \"\") %>%\n    group_by(MacrocategoriaTxt, CaregoriaTxt) %>%\n    summarise(\n      x_cat = mean(.data[[xcol]], na.rm = TRUE),\n      y_cat = mean(.data[[ycol]], na.rm = TRUE),\n      n_cat = n(),\n      n_filmes = n_distinct(FilmeNome),\n      top_dna = paste0(head(names(sort(table(DNAMnemTxt), decreasing = TRUE)), 3), collapse = \"; \"),\n      .groups = \"drop\"\n    ) %>%\n    rename(Macrocategoria = MacrocategoriaTxt, Caregoria = CaregoriaTxt)\n  \n  cat_cent$hover_cat <- paste0(\n    \"<b>Caregoria:<\/b> \", safe_chr(cat_cent$Caregoria),\n    \"<br><b>Macrocategoria:<\/b> \", safe_chr(cat_cent$Macrocategoria),\n    \"<br><b>n:<\/b> \", cat_cent$n_cat,\n    \"<br><b>n filmes:<\/b> \", cat_cent$n_filmes,\n    ifelse(is.na(cat_cent$top_dna) | cat_cent$top_dna == \"\", \"\", paste0(\"<br><b>Top DNA-Mnem:<\/b> \", safe_chr(cat_cent$top_dna))),\n    \"<hr>\",\n    \"<b>Centróide X:<\/b> \", format(cat_cent$x_cat, digits = 6),\n    \"<br><b>Centróide Y:<\/b> \", format(cat_cent$y_cat, digits = 6)\n  )\n  \n  # Linhas filme → agentes exibidos\n  linhas_filme_agente <- d_points %>%\n    select(FilmeNome, all_of(xcol), all_of(ycol)) %>%\n    left_join(filmes_cent %>% select(FilmeNome, x_filme, y_filme), by = \"FilmeNome\") %>%\n    filter(!is.na(x_filme), !is.na(y_filme)) %>%\n    mutate(x0 = x_filme, y0 = y_filme, x1 = .data[[xcol]], y1 = .data[[ycol]])\n  \n  # Linhas categoria → macro\n  linhas_cat_macro <- cat_cent %>%\n    left_join(macro_cent %>% select(Macrocategoria, x_macro, y_macro), by = \"Macrocategoria\") %>%\n    filter(!is.na(x_macro), !is.na(y_macro)) %>%\n    mutate(x0 = x_cat, y0 = y_cat, x1 = x_macro, y1 = y_macro)\n  \n  linha_op_1 <- min(0.60, max(0.05, transparencia * 0.35))\n  linha_op_2 <- min(0.60, max(0.05, transparencia * 0.45))\n  \n  # Tamanho agentes\n  if (!is.null(var_tamanho) && var_tamanho != \"none\" && var_tamanho %in% names(d_points)) {\n    v <- d_points[[var_tamanho]]\n    if (all(is.na(v))) d_points$TamanhoPonto <- 10\n    else d_points$TamanhoPonto <- ifelse(is.na(v), 10, scales::rescale(v, to = c(8, 22)))\n  } else {\n    if (\"n\" %in% names(d_points)) {\n      cap <- suppressWarnings(quantile(d_points$n, 0.95, na.rm = TRUE))\n      if (is.na(cap) || cap <= 0) cap <- max(d_points$n, na.rm = TRUE)\n      d_points$TamanhoPonto <- scales::rescale(pmin(d_points$n, cap), to = c(9, 26))\n    } else d_points$TamanhoPonto <- 10\n  }\n  \n  # Hover agentes (inclui macro/caregoria/dna)\n  mac <- if (\"Macrocategoria\" %in% names(d_points)) safe_chr(d_points$Macrocategoria) else rep(\"\", nrow(d_points))\n  careg <- if (\"Caregoria\" %in% names(d_points)) safe_chr(d_points$Caregoria) else rep(\"\", nrow(d_points))\n  dna <- if (\"DNA-Mnem\" %in% names(d_points)) safe_chr(d_points$`DNA-Mnem`) else rep(\"\", nrow(d_points))\n  \n  d_points$hover <- paste0(\n    \"<b>Filme:<\/b> \", safe_chr(d_points$FilmeNome),\n    \"<br><b>Categoria_Agente:<\/b> \", safe_chr(d_points$Categoria_Agente),\n    \"<br><b>Agente Padronizado:<\/b> \", safe_chr(d_points$AgentePad),\n    \"<br><b>Tema:<\/b> \", safe_chr(d_points$TemaNivel),\n    if (any(mac != \"\")) paste0(\"<br><b>Macrocategoria:<\/b> \", mac) else \"\",\n    if (any(careg != \"\")) paste0(\"<br><b>Caregoria:<\/b> \", careg) else \"\",\n    if (any(dna != \"\")) paste0(\"<br><b>DNA-Mnem:<\/b> \", dna) else \"\",\n    if (\"n\" %in% names(d_points)) paste0(\"<br><b>n (agregado):<\/b> \", d_points$n) else \"\",\n    \"<hr>\",\n    \"<b>X:<\/b> \", format(d_points[[xcol]], digits = 6),\n    \"<br><b>Y:<\/b> \", format(d_points[[ycol]], digits = 6)\n  )\n  \n  p <- plot_ly()\n  \n  if (nrow(linhas_cat_macro) > 0) {\n    p <- p %>% add_segments(\n      data = linhas_cat_macro,\n      x = ~x0, y = ~y0, xend = ~x1, yend = ~y1,\n      inherit = FALSE, showlegend = FALSE, hoverinfo = \"skip\",\n      line = list(color = LINHA_COR_CAT_MACRO, width = LINHA_LARGURA),\n      opacity = linha_op_2\n    )\n  }\n  \n  if (nrow(linhas_filme_agente) > 0) {\n    p <- p %>% add_segments(\n      data = linhas_filme_agente,\n      x = ~x0, y = ~y0, xend = ~x1, yend = ~y1,\n      inherit = FALSE, showlegend = FALSE, hoverinfo = \"skip\",\n      line = list(color = LINHA_COR_FILME_AGENTE, width = LINHA_LARGURA),\n      opacity = linha_op_1\n    )\n  }\n  \n  if (nrow(macro_cent) > 0) {\n    p <- p %>% add_trace(\n      data = macro_cent,\n      x = ~x_macro, y = ~y_macro,\n      type = \"scatter\", mode = \"markers\",\n      name = \"Macrocategoria\",\n      text = ~hover_macro, hoverinfo = \"text\",\n      marker = list(size = MACRO_SIZE, color = MACRO_COR, symbol = MACRO_SYMBOL,\n                    opacity = transparencia, line = list(width = 1.2, color = \"black\"))\n    )\n  }\n  \n  if (nrow(cat_cent) > 0) {\n    p <- p %>% add_trace(\n      data = cat_cent,\n      x = ~x_cat, y = ~y_cat,\n      type = \"scatter\", mode = \"markers\",\n      name = \"Caregoria\",\n      text = ~hover_cat, hoverinfo = \"text\",\n      marker = list(size = CAT_SIZE, color = CAT_COR, symbol = CAT_SYMBOL,\n                    opacity = transparencia, line = list(width = 1.0, color = \"black\"))\n    )\n  }\n  \n  cats <- sort(unique(as.character(d_points$Categoria_Agente)))\n  for (ct in cats) {\n    dd <- d_points %>% filter(as.character(Categoria_Agente) == ct)\n    p <- p %>% add_trace(\n      data = dd,\n      x = ~.data[[xcol]], y = ~.data[[ycol]],\n      type = \"scatter\", mode = \"markers\",\n      name = ct,\n      text = ~hover, hoverinfo = \"text\",\n      marker = list(size = ~TamanhoPonto, opacity = transparencia,\n                    color = PALETA_CORES[[ct]] %||% \"#9E9E9E\",\n                    symbol = PLOTLY_SYMBOLS[[ct]] %||% \"circle\",\n                    line = list(width = 1, color = \"black\"))\n    )\n  }\n  \n  if (nrow(filmes_cent) > 0) {\n    p <- p %>% add_trace(\n      data = filmes_cent,\n      x = ~x_filme, y = ~y_filme,\n      type = \"scatter\", mode = \"markers\",\n      name = \"Filme\",\n      text = ~hover_filme, hoverinfo = \"text\",\n      marker = list(size = FILME_SIZE, color = FILME_COR, symbol = FILME_SYMBOL,\n                    opacity = transparencia, line = list(width = 1.2, color = \"black\"))\n    )\n  }\n  \n  p %>%\n    layout(\n      title = list(text = paste0(\"<b>\", xcol, \" × \", ycol, \"<\/b>\"), x = 0.5),\n      xaxis = list(title = xcol, gridcolor = \"#ecf0f1\", zerolinecolor = \"#bdc3c7\"),\n      yaxis = list(title = ycol, gridcolor = \"#ecf0f1\", zerolinecolor = \"#bdc3c7\"),\n      plot_bgcolor = \"#ffffff\",\n      paper_bgcolor = \"#ffffff\",\n      showlegend = mostrar_legenda,\n      legend = list(orientation = \"h\", x = 0.5, xanchor = \"center\", y = -0.18),\n      hovermode = \"closest\",\n      margin = list(l = 70, r = 30, t = 70, b = 110)\n    ) %>%\n    config(displaylogo = FALSE, scrollZoom = TRUE)\n}\n\n# ------------------------------------------------------------------------------\n# 8) UI (igual ao seu último)\n# ------------------------------------------------------------------------------\ngrupo_choices <- c(\"Categoria_Agente\",\"AgentePad\",\"TemaNivel\",\"MacrocategoriaTxt\",\"CaregoriaTxt\",\"FilmeNome\")\ngrupo_labels <- c(\n  \"Categoria de Agente\",\"Agente Padronizado\",\"Tema (Nível)\",\"Macrocategoria\",\"Caregoria\",\"Filme\"\n)\nnames(grupo_labels) <- grupo_choices\n\nmake_plotly_violin <- function(d, medida, grupo, transparencia = 0.7) {\n  d2 <- d %>% filter(!is.na(.data[[medida]])) %>% mutate(Grupo = as.character(.data[[grupo]]))\n  if (nrow(d2) == 0) return(plot_ly() %>% layout(title = list(text = \"Sem dados para violino\", x = 0.5)))\n  top_grupos <- d2 %>% count(Grupo, sort = TRUE) %>% slice_head(n = 30) %>% pull(Grupo)\n  d2 <- d2 %>% filter(Grupo %in% top_grupos)\n  \n  plot_ly(d2, x = ~Grupo, y = ~.data[[medida]], type = \"violin\",\n          box = list(visible = TRUE), meanline = list(visible = TRUE),\n          points = \"outliers\", opacity = transparencia) %>%\n    layout(\n      title = list(text = paste0(\"<b>Violino — \", medida, \" por \", grupo, \"<\/b>\"), x = 0.5),\n      xaxis = list(title = grupo, tickangle = -30),\n      yaxis = list(title = medida),\n      plot_bgcolor = \"#ffffff\", paper_bgcolor = \"#ffffff\",\n      margin = list(l = 70, r = 30, t = 70, b = 110)\n    ) %>% config(displaylogo = FALSE, scrollZoom = TRUE)\n}\n\nmake_plotly_bar <- function(d, medida, grupo, fun = \"mean\", transparencia = 0.9) {\n  d2 <- d %>% mutate(Grupo = as.character(.data[[grupo]]))\n  \n  if (fun == \"count\") {\n    agg <- d2 %>% count(Grupo, name = \"valor\") %>% arrange(desc(valor))\n    ytitle <- \"Contagem\"\n  } else {\n    d2 <- d2 %>% filter(!is.na(.data[[medida]]))\n    if (nrow(d2) == 0) return(plot_ly() %>% layout(title = list(text = \"Sem dados para barras\", x = 0.5)))\n    agg <- d2 %>%\n      group_by(Grupo) %>%\n      summarise(\n        valor = dplyr::case_when(\n          fun == \"mean\" ~ mean(.data[[medida]], na.rm = TRUE),\n          fun == \"median\" ~ median(.data[[medida]], na.rm = TRUE),\n          fun == \"sum\" ~ sum(.data[[medida]], na.rm = TRUE),\n          TRUE ~ mean(.data[[medida]], na.rm = TRUE)\n        ),\n        .groups = \"drop\"\n      ) %>% arrange(desc(valor))\n    ytitle <- paste0(fun, \"(\", medida, \")\")\n  }\n  \n  agg <- agg %>% slice_head(n = 30)\n  \n  plot_ly(agg, x = ~reorder(Grupo, valor), y = ~valor, type = \"bar\", opacity = transparencia) %>%\n    layout(\n      title = list(text = paste0(\"<b>Barras — \", ytitle, \" por \", grupo, \"<\/b>\"), x = 0.5),\n      xaxis = list(title = grupo, tickangle = -30),\n      yaxis = list(title = ytitle),\n      plot_bgcolor = \"#ffffff\", paper_bgcolor = \"#ffffff\",\n      margin = list(l = 70, r = 30, t = 70, b = 110)\n    ) %>% config(displaylogo = FALSE, scrollZoom = TRUE)\n}\n\nui <- fluidPage(\n  tags$head(\n    tags$style(HTML(\"\n      body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f5f7fa; }\n      .title-panel {\n        background: linear-gradient(135deg, #2c3e50, #3498db);\n        color: white; padding: 18px; border-radius: 10px; margin-bottom: 16px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.10);\n      }\n      .well {\n        background-color: white; border-radius: 10px; border: 1px solid #e1e8ed;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n      }\n      .btn-primary { background: linear-gradient(135deg, #2c3e50, #3498db); border: none; font-weight: bold; }\n      .stat-card {\n        background: white; border-radius: 10px; padding: 12px; margin: 8px 0;\n        box-shadow: 0 2px 6px rgba(0,0,0,0.08);\n        border-left: 4px solid #3498db;\n      }\n      .small-note { color: #7f8c8d; font-style: italic; text-align: center; }\n      .sub-controls { background:#ffffff; border:1px solid #e1e8ed; border-radius:10px; padding:12px; margin-bottom:12px; }\n    \"))\n  ),\n  div(class = \"title-panel\",\n      h2(\"ANÁLISE DE AGENTES — FCT IA 2024\", style = \"margin:0;\"),\n      h4(\"Dispersão, violino e barras com filtros múltiplos (AND) e listas sincronizadas\", style = \"margin:6px 0 0 0; opacity:0.9;\")\n  ),\n  sidebarLayout(\n    sidebarPanel(\n      width = 3,\n      div(class = \"well\",\n          h4(\"FILTROS (multi)\"),\n          selectizeInput(\n            \"filtro_categoria_agente\", \"Categoria de Agente:\",\n            choices = levels(dados$Categoria_Agente),\n            selected = levels(dados$Categoria_Agente),\n            multiple = TRUE,\n            options = list(plugins = list(\"remove_button\", \"drag_drop\"), placeholder = \"Selecione uma ou mais…\")\n          ),\n          selectizeInput(\n            \"filtro_agente_pad\", \"Agente Padronizado:\",\n            choices = sort(unique(na.omit(dados$AgentePad))),\n            selected = sort(unique(na.omit(dados$AgentePad))),\n            multiple = TRUE,\n            options = list(plugins = list(\"remove_button\"), placeholder = \"Selecione…\")\n          ),\n          selectizeInput(\n            \"filtro_tema\", \"Tema (Nível):\",\n            choices = sort(unique(na.omit(dados$TemaNivel))),\n            selected = sort(unique(na.omit(dados$TemaNivel))),\n            multiple = TRUE,\n            options = list(plugins = list(\"remove_button\"), placeholder = \"Selecione…\")\n          ),\n          selectizeInput(\n            \"filtro_macrocategoria\", \"Macrocategoria:\",\n            choices = sort(unique(na.omit(dados$MacrocategoriaTxt))),\n            selected = sort(unique(na.omit(dados$MacrocategoriaTxt))),\n            multiple = TRUE,\n            options = list(plugins = list(\"remove_button\"), placeholder = \"Selecione…\")\n          ),\n          selectizeInput(\n            \"filtro_caregoria\", \"Caregoria (busca):\",\n            choices = sort(unique(na.omit(dados$CaregoriaTxt))),\n            selected = sort(unique(na.omit(dados$CaregoriaTxt))),\n            multiple = TRUE,\n            options = list(plugins = list(\"remove_button\"), placeholder = \"Digite para buscar…\")\n          ),\n          selectizeInput(\n            \"filtro_filme\", \"Filme (Nome) — opcional:\",\n            choices = sort(unique(na.omit(dados$FilmeNome))),\n            selected = character(0),\n            multiple = TRUE,\n            options = list(plugins = list(\"remove_button\"), placeholder = \"Se vazio = todos\")\n          )\n      ),\n      div(class = \"well\",\n          h4(\"CONTROLES DO GRÁFICO (Dispersão)\"),\n          selectInput(\"eixo_x\", \"Eixo X:\", choices = colunas_numericas, selected = default_x),\n          selectInput(\"eixo_y\", \"Eixo Y:\", choices = colunas_numericas, selected = default_y),\n          selectInput(\"var_tamanho\", \"Tamanho por:\", choices = c(\"Nenhum\" = \"none\", colunas_numericas), selected = \"none\"),\n          sliderInput(\"transparencia\", \"Transparência:\", 0.1, 1, 0.7, 0.1),\n          checkboxInput(\"mostrar_legenda\", \"Mostrar legenda\", TRUE),\n          checkboxInput(\"agregar\", \"Agregação (reduzir pontos)\", TRUE),\n          selectInput(\"agregacao_tipo\", \"Agregação por:\",\n                      choices = c(\"Filme × Tema × Categoria\" = \"ftc\", \"Filme × Categoria\" = \"fc\", \"Tema × Categoria\" = \"tc\"),\n                      selected = \"ftc\")\n      ),\n      div(class = \"well\",\n          h4(\"AÇÕES\"),\n          actionButton(\"btn_aplicar\", \"APLICAR FILTROS\", class = \"btn-primary\", width = \"100%\"),\n          tags$div(style = \"height:8px;\"),\n          actionButton(\"btn_reset\", \"RESTAURAR PADRÕES\", width = \"100%\",\n                       style = \"background-color:#95a5a6; color:white; border:none;\"),\n          tags$div(style = \"height:8px;\"),\n          actionButton(\"btn_salvar_html\", \"SALVAR HTML (outputs)\", width = \"100%\")\n      ),\n      div(class = \"well\",\n          h4(\"ESTATÍSTICAS\"),\n          div(class = \"stat-card\",\n              div(style=\"font-size:12px; color:#7f8c8d;\", \"TOTAL DE REGISTROS\"),\n              div(style=\"font-size:22px; font-weight:bold;\", textOutput(\"total_registros\", inline = TRUE))\n          ),\n          div(class = \"stat-card\",\n              div(style=\"font-size:12px; color:#7f8c8d;\", \"REGISTROS FILTRADOS\"),\n              div(style=\"font-size:22px; font-weight:bold; color:#e74c3c;\", textOutput(\"dados_filtrados\", inline = TRUE))\n          ),\n          div(class = \"stat-card\",\n              div(style=\"font-size:12px; color:#7f8c8d;\", \"CATEGORIAS ATIVAS\"),\n              div(style=\"font-size:22px; font-weight:bold; color:#27ae60;\", textOutput(\"categorias_ativas\", inline = TRUE))\n          )\n      )\n    ),\n    mainPanel(\n      width = 9,\n      tabsetPanel(\n        tabPanel(\"Dispersão\",\n                 div(style=\"background:white; border-radius:10px; padding:18px;\",\n                     h3(\"DISPERSÃO\", style=\"margin-top:0;\"),\n                     plotlyOutput(\"grafico\", height = \"650px\"),\n                     tags$p(\"Passe o mouse para detalhes. Use zoom/pan do Plotly.\", class=\"small-note\")\n                 )\n        ),\n        tabPanel(\"Violino\",\n                 div(style=\"background:white; border-radius:10px; padding:18px;\",\n                     h3(\"GRÁFICO DE VIOLINO\", style=\"margin-top:0;\"),\n                     div(class=\"sub-controls\",\n                         fluidRow(\n                           column(6, selectInput(\"violin_medida\", \"Medida (numérica):\",\n                                                 choices = colunas_numericas, selected = default_y)),\n                           column(6, selectInput(\"violin_grupo\", \"Agrupar por:\",\n                                                 choices = setNames(grupo_choices, grupo_labels[grupo_choices]),\n                                                 selected = \"Categoria_Agente\"))\n                         )\n                     ),\n                     plotlyOutput(\"grafico_violin\", height = \"600px\")\n                 )\n        ),\n        tabPanel(\"Barras\",\n                 div(style=\"background:white; border-radius:10px; padding:18px;\",\n                     h3(\"GRÁFICO DE BARRAS\", style=\"margin-top:0;\"),\n                     div(class=\"sub-controls\",\n                         fluidRow(\n                           column(4, selectInput(\"bar_medida\", \"Medida (numérica):\",\n                                                 choices = colunas_numericas, selected = default_y)),\n                           column(4, selectInput(\"bar_grupo\", \"Agrupar por:\",\n                                                 choices = setNames(grupo_choices, grupo_labels[grupo_choices]),\n                                                 selected = \"Categoria_Agente\")),\n                           column(4, selectInput(\"bar_fun\", \"Agregação:\",\n                                                 choices = c(\"Média\"=\"mean\",\"Mediana\"=\"median\",\"Soma\"=\"sum\",\"Contagem\"=\"count\"),\n                                                 selected = \"mean\"))\n                         )\n                     ),\n                     plotlyOutput(\"grafico_bar\", height = \"600px\")\n                 )\n        ),\n        tabPanel(\"Tabela\",\n                 div(style=\"background:white; border-radius:10px; padding:18px;\",\n                     h3(\"DADOS FILTRADOS\", style=\"margin-top:0;\"),\n                     DTOutput(\"tabela\")\n                 )\n        )\n      )\n    )\n  )\n)\n\n# ------------------------------------------------------------------------------\n# 9) SERVER — CORREÇÃO PRINCIPAL: sincronizar choices/selected em cascata (AND)\n# ------------------------------------------------------------------------------\nserver <- function(input, output, session) {\n  \n  output$total_registros <- renderText({\n    format(nrow(dados), big.mark=\".\", decimal.mark=\",\")\n  })\n  \n  # Helper: atualiza selectize respeitando AND (interseção)\n  sync_selectize <- function(id, choices_vec, selected_current, allow_empty = FALSE, prefer_all_when_empty = TRUE) {\n    choices_vec <- sort(unique(na.omit(choices_vec)))\n    selected_current <- selected_current %||% character(0)\n    selected_new <- intersect(selected_current, choices_vec)\n    \n    if (!allow_empty) {\n      # Para filtros \"não opcionais\": se ficar vazio, seleciona tudo disponível\n      if (length(selected_new) == 0 && prefer_all_when_empty) selected_new <- choices_vec\n    } else {\n      # Para filtros opcionais (Filme): pode ficar vazio\n      # Se havia seleção mas saiu do universo, zera\n      if (length(selected_current) > 0 && length(selected_new) == 0) selected_new <- character(0)\n    }\n    \n    updateSelectizeInput(session, id, choices = choices_vec, selected = selected_new, server = TRUE)\n  }\n  \n  observeEvent(input$btn_reset, {\n    updateSelectizeInput(session, \"filtro_categoria_agente\", choices = levels(dados$Categoria_Agente), selected = levels(dados$Categoria_Agente), server = TRUE)\n    updateSelectizeInput(session, \"filtro_agente_pad\", choices = sort(unique(na.omit(dados$AgentePad))), selected = sort(unique(na.omit(dados$AgentePad))), server = TRUE)\n    updateSelectizeInput(session, \"filtro_tema\", choices = sort(unique(na.omit(dados$TemaNivel))), selected = sort(unique(na.omit(dados$TemaNivel))), server = TRUE)\n    updateSelectizeInput(session, \"filtro_macrocategoria\", choices = sort(unique(na.omit(dados$MacrocategoriaTxt))), selected = sort(unique(na.omit(dados$MacrocategoriaTxt))), server = TRUE)\n    updateSelectizeInput(session, \"filtro_caregoria\", choices = sort(unique(na.omit(dados$CaregoriaTxt))), selected = sort(unique(na.omit(dados$CaregoriaTxt))), server = TRUE)\n    updateSelectizeInput(session, \"filtro_filme\", choices = sort(unique(na.omit(dados$FilmeNome))), selected = character(0), server = TRUE)\n    \n    updateSelectInput(session, \"eixo_x\", selected = default_x)\n    updateSelectInput(session, \"eixo_y\", selected = default_y)\n    updateSelectInput(session, \"var_tamanho\", selected = \"none\")\n    updateSliderInput(session, \"transparencia\", value = 0.7)\n    updateCheckboxInput(session, \"mostrar_legenda\", value = TRUE)\n    updateCheckboxInput(session, \"agregar\", value = TRUE)\n    updateSelectInput(session, \"agregacao_tipo\", selected = \"ftc\")\n    \n    updateSelectInput(session, \"violin_medida\", selected = default_y)\n    updateSelectInput(session, \"violin_grupo\", selected = \"Categoria_Agente\")\n    updateSelectInput(session, \"bar_medida\", selected = default_y)\n    updateSelectInput(session, \"bar_grupo\", selected = \"Categoria_Agente\")\n    updateSelectInput(session, \"bar_fun\", selected = \"mean\")\n    \n    showNotification(\"Padrões restaurados.\", type = \"message\", duration = 2)\n  })\n  \n  # Aplica filtros (AND) e, em seguida, sincroniza as listas (choices) com o recorte final\n  dados_filtrados <- eventReactive(input$btn_aplicar, {\n    d <- dados\n    \n    if (!is.null(input$filtro_categoria_agente) && length(input$filtro_categoria_agente) > 0) {\n      d <- d %>% filter(Categoria_Agente %in% input$filtro_categoria_agente)\n    }\n    if (!is.null(input$filtro_agente_pad) && length(input$filtro_agente_pad) > 0) {\n      d <- d %>% filter(AgentePad %in% input$filtro_agente_pad)\n    }\n    if (!is.null(input$filtro_tema) && length(input$filtro_tema) > 0) {\n      d <- d %>% filter(TemaNivel %in% input$filtro_tema)\n    }\n    if (!is.null(input$filtro_macrocategoria) && length(input$filtro_macrocategoria) > 0) {\n      d <- d %>% filter(MacrocategoriaTxt %in% input$filtro_macrocategoria)\n    }\n    if (!is.null(input$filtro_caregoria) && length(input$filtro_caregoria) > 0) {\n      d <- d %>% filter(CaregoriaTxt %in% input$filtro_caregoria)\n    }\n    if (!is.null(input$filtro_filme) && length(input$filtro_filme) > 0) {\n      d <- d %>% filter(FilmeNome %in% input$filtro_filme)\n    }\n    \n    d <- add_calculated_measures(d)\n    \n    # Sincroniza choices/selected com o universo filtrado (AND real)\n    # (Isto evita a sensação de “não filtrou filmes/categorias”, pois tudo passa a refletir o recorte)\n    isolate({\n      sync_selectize(\"filtro_categoria_agente\", levels(d$Categoria_Agente), input$filtro_categoria_agente, allow_empty = FALSE)\n      sync_selectize(\"filtro_agente_pad\", d$AgentePad, input$filtro_agente_pad, allow_empty = FALSE)\n      sync_selectize(\"filtro_tema\", d$TemaNivel, input$filtro_tema, allow_empty = FALSE)\n      sync_selectize(\"filtro_macrocategoria\", d$MacrocategoriaTxt, input$filtro_macrocategoria, allow_empty = FALSE)\n      sync_selectize(\"filtro_caregoria\", d$CaregoriaTxt, input$filtro_caregoria, allow_empty = FALSE)\n      sync_selectize(\"filtro_filme\", d$FilmeNome, input$filtro_filme, allow_empty = TRUE, prefer_all_when_empty = FALSE)\n    })\n    \n    d\n  }, ignoreNULL = FALSE)\n  \n  output$dados_filtrados <- renderText({\n    d <- dados_filtrados()\n    pct <- round(nrow(d) / nrow(dados) * 100, 1)\n    paste0(format(nrow(d), big.mark=\".\", decimal.mark=\",\"), \" (\", pct, \"%)\")\n  })\n  \n  output$categorias_ativas <- renderText({\n    d <- dados_filtrados()\n    length(unique(d$Categoria_Agente))\n  })\n  \n  plot_data <- reactive({\n    d <- dados_filtrados()\n    req(nrow(d) > 0)\n    prep_plot_data(\n      d = d,\n      xcol = input$eixo_x,\n      ycol = input$eixo_y,\n      agregar = isTRUE(input$agregar),\n      tipo = input$agregacao_tipo %||% \"ftc\"\n    )\n  })\n  \n  output$grafico <- renderPlotly({\n    d_base <- dados_filtrados()\n    d_pts <- plot_data()\n    make_plotly_scatter(\n      d_points = d_pts,\n      d_base = d_base,\n      xcol = input$eixo_x,\n      ycol = input$eixo_y,\n      var_tamanho = input$var_tamanho %||% \"none\",\n      transparencia = input$transparencia %||% 0.7,\n      mostrar_legenda = isTRUE(input$mostrar_legenda)\n    )\n  })\n  \n  output$grafico_violin <- renderPlotly({\n    d <- dados_filtrados()\n    req(nrow(d) > 0)\n    make_plotly_violin(\n      d = d,\n      medida = input$violin_medida %||% default_y,\n      grupo = input$violin_grupo %||% \"Categoria_Agente\",\n      transparencia = input$transparencia %||% 0.7\n    )\n  })\n  \n  output$grafico_bar <- renderPlotly({\n    d <- dados_filtrados()\n    req(nrow(d) > 0)\n    make_plotly_bar(\n      d = d,\n      medida = input$bar_medida %||% default_y,\n      grupo = input$bar_grupo %||% \"Categoria_Agente\",\n      fun = input$bar_fun %||% \"mean\",\n      transparencia = min(1, max(0.15, (input$transparencia %||% 0.7) + 0.2))\n    )\n  })\n  \n  output$tabela <- renderDT({\n    d <- dados_filtrados()\n    keep_cols <- intersect(\n      c(\n        \"FilmeNome\", \"AgentePad\", \"TemaNivel\", \"Categoria_Agente\",\n        \"MacrocategoriaTxt\", \"CaregoriaTxt\", \"DNAMnemTxt\",\n        \"FreqAgente_Filtrado\", \"ScoreNivelTemaTxt\", \"MedidaPonderada_FreqAgente_x_ScoreTema\",\n        input$eixo_x, input$eixo_y\n      ),\n      names(d)\n    )\n    \n    d_view <- d %>% select(all_of(keep_cols))\n    nm <- names(d_view)\n    nm[nm == \"MacrocategoriaTxt\"] <- \"Macrocategoria\"\n    nm[nm == \"CaregoriaTxt\"] <- \"Caregoria\"\n    nm[nm == \"DNAMnemTxt\"] <- \"DNA-Mnem\"\n    nm[nm == \"ScoreNivelTemaTxt\"] <- \"Score Nível Tema\"\n    names(d_view) <- nm\n    \n    datatable(\n      d_view,\n      options = list(pageLength = 10, scrollX = TRUE),\n      rownames = FALSE\n    )\n  })\n  \n  observeEvent(input$btn_salvar_html, {\n    d_base <- dados_filtrados()\n    d_pts <- plot_data()\n    \n    if (is.null(d_pts) || nrow(d_pts) == 0) {\n      showNotification(\"Nada para salvar (sem dados).\", type = \"error\", duration = 3)\n      return()\n    }\n    \n    p <- make_plotly_scatter(\n      d_points = d_pts,\n      d_base = d_base,\n      xcol = input$eixo_x,\n      ycol = input$eixo_y,\n      var_tamanho = input$var_tamanho %||% \"none\",\n      transparencia = input$transparencia %||% 0.7,\n      mostrar_legenda = isTRUE(input$mostrar_legenda)\n    )\n    \n    path <- next_version_path(prefix = \"dispersao_agentes\", ext = \".html\")\n    htmlwidgets::saveWidget(p, file = path, selfcontained = TRUE)\n    showNotification(paste0(\"Salvo em: \", path), type = \"message\", duration = 4)\n  })\n  \n  observeEvent(input$btn_aplicar, {\n    d <- dados_filtrados()\n    showNotification(paste0(\"Filtros aplicados: \", nrow(d), \" registros.\"), type = \"message\", duration = 2)\n  })\n}\n\nshinyApp(ui = ui, server = server)\n\n","type":"text"}]
